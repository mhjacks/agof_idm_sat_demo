---
- name: initial check setup
  hosts: localhost
  connection: local
  become: false
  gather_facts: true
  vars_files:
    - vars/aws_vars.yml
    - vars/aws_vault.yml
    - vars/builder_vars.yml
    - vars/builder_vault.yml
    - vars/idm_vars.yml
    - vars/idm_vault.yml
    - vars/sat_vars.yml
    - vars/sat_vault.yml
  vars:
    ec2_wait: true
  tasks:

    - name: collection final check
      block:
        - name: run AWS check setup if using AWS
          ansible.builtin.include_role:
            name: roles/aws_check_setup

      rescue:
        - name: Error with setup
          fail:
            msg: The provisioner has failed during initial check_setup, please scroll up to see exact error.  Open an issue on https://github.com/ansible/workshops/issues

#    - name: add dns entries
#      include_role:
#        name: roles/aws_dns
#      when:
#        - dns_type is defined
#        - dns_type == "aws"

    - name: Provision network stuff
      ansible.builtin.include_role:
        name: roles/manage_ec2_infra

    - name: "Build the imagebuilder image"
      ansible.builtin.include_tasks: tasks/buildimage.yml
      tags:
        - buildimage
      when: imagebuilder_ami is not defined

    - name: "Display the imagebuilder image"
      ansible.builtin.debug:
        msg: "imagebuilder_ami is {{ imagebuilder_ami }}"

    - name: Provision idm machine
      ansible.builtin.include_tasks: tasks/create_idm_ec2.yml

    - name: Provision satellite machine
      ansible.builtin.include_tasks: tasks/create_sat_ec2.yml

    - name: Build inventory for subsequent plays
      ansible.builtin.include_role:
        name: roles/build_bootstrap_inventory

- name: Post-provisioning tasks
  hosts: idm:sat
  become: true
  gather_facts: true
  tasks:
    - name: Debug facts
      ansible.builtin.debug:
        var: ansible_facts

    - name: Expand EBS disks
      ansible.builtin.include_role:
        name: roles/expand_ec2_ebs

#    # Set hosts files
#
#- name: IdM-specific Post-provisioning tasks
#  hosts: idm
#  become: true
#  gather_facts: true
#  tasks:
#    # Disk layout
#
#- name: Satellite-specific Post-provisioning tasks
#  hosts: satellite
#  become: true
#  gather_facts: true
#  tasks:
#    # Disk layout
